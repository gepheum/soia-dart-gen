# Dart Soia Generator Unit Tests

This test suite provides comprehensive unit tests for the Dart code generated by the Soia code generator. The tests are modeled after the Kotlin unit tests found in [soia-kotlin-gen](https://github.com/gepheum/soia-kotlin-gen/blob/main/e2e-test/src/test/kotlin/Tests.kt).

## Test Coverage

The test suite covers 27 different aspects of the generated code across 6 main categories:

### 1. Generated struct tests (9 tests)
- `toString()` formatting
- `equals()` method (currently broken)
- `hashCode` consistency
- `toMutable()` functionality
- `toFrozen()` returns this for immutable objects
- Mutable getters for complex types
- `_OrMutable` sealed interface
- Default instances and static factory methods
- Recursive structures

### 2. Generated enum tests (5 tests)
- Enum instance creation
- `toString()` formatting
- `equals()` and `hashCode`
- `kind` property
- Switch pattern matching

### 3. Serialization tests (3 tests)
- Struct serialization and deserialization
- Enum serialization and deserialization
- Schema change compatibility

### 4. Constants tests (1 test)
- Generated constants

### 5. Vehicles module tests (1 test)
- Car struct functionality

### 6. Potential bugs and limitations (8 tests)
- Documented bugs in the current implementation

## Identified Bugs

The test suite identifies several significant bugs in the current Dart code generator:

### Critical Bug: Broken `equals()` Method
**Issue**: The generated `equals()` method is fundamentally broken due to how Dart handles List equality.

**Details**: 
- The `_equality_proxy` getter returns a new List instance each time it's called
- In Dart, `[1, 2] == [1, 2]` returns `false` because Lists are compared by identity, not content
- This means `equals()` will always return `false` even for objects with identical field values

**Example**:
```dart
final person1 = FullName(firstName: "John", lastName: "Doe");
final person2 = FullName(firstName: "John", lastName: "Doe");
person1.equals(person2); // Returns false (should be true)
```

### Standard Dart Practice Issues
**Issue**: The generated code doesn't follow standard Dart equality patterns.

**Details**:
- Uses `equals()` method instead of overriding the `==` operator
- This makes the objects incompatible with Dart collections (Set, Map)
- Standard Dart practice is to override `==` and `hashCode` together

### Collection Behavior Differences
**Issue**: Mutable collections may not behave like their Kotlin counterparts.

**Details**:
- Dart's collection handling differs from Kotlin's MutableList
- The generated mutable getters may not provide the same functionality

### Missing Features
- Keyed list `mapView` functionality from Kotlin may not be implemented
- Complex enums with value fields may not be supported
- Recursive field handling may be incomplete

## Running the Tests

From the `e2e-test` directory:

```bash
# Install dependencies
dart pub get

# Run all tests
dart test test/tests.dart

# Run with expanded output
dart test test/tests.dart --reporter=expanded
```

## Test Philosophy

These tests serve two purposes:

1. **Verification**: Ensure the generated code works as expected
2. **Documentation**: Document bugs and limitations in the current implementation

The tests are written to **expect the current (incorrect) behavior** while clearly documenting what the correct behavior should be. This approach:

- Prevents tests from failing due to known bugs
- Provides clear documentation of issues for future fixes
- Serves as regression tests to ensure bugs don't get worse

## Comparison with Kotlin Implementation

The tests closely mirror the structure and intent of the Kotlin tests, but account for language differences:

- Dart uses different equality patterns than Kotlin
- Collection handling differs between the languages
- Type system differences require different approaches
- Some Kotlin features may not have direct Dart equivalents

## Recommendations for Code Generator Improvements

1. **Fix equality implementation**: Use proper Dart equality patterns with `==` operator override
2. **Implement deep equality**: Use a proper deep equality comparison for complex objects
3. **Follow Dart conventions**: Use standard Dart patterns for generated code
4. **Add missing features**: Implement keyed list mapView and complex enum support
5. **Improve mutable collections**: Ensure mutable getters work like Kotlin equivalents

## Contributing

When adding new tests:

1. Follow the pattern of testing both expected behavior and documenting bugs
2. Use descriptive test names that clearly indicate what's being tested
3. Include comments explaining any bugs or limitations
4. Group related tests together
5. Update this README when adding new test categories
